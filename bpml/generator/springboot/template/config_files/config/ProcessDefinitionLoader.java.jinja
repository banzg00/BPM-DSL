package {{ group_name }}.{{ app_name_lower }}.config;

import {{ group_name }}.{{ app_name_lower }}.model.ProcessDefinition;
import {{ group_name }}.{{ app_name_lower }}.repository.ProcessDefinitionRepository;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.util.*;

/**
 * Loads process definitions into the database at application startup
 */
@Component
@RequiredArgsConstructor
@Slf4j
public class ProcessDefinitionLoader implements CommandLineRunner {

    private final ProcessDefinitionRepository processDefinitionRepository;
    private final ObjectMapper objectMapper;

    @Override
    public void run(String... args) throws Exception {
        log.info("Loading process definitions...");

        {% for process in processes %}
        loadProcessDefinition_{{ process.name }}();
        {% endfor %}

        log.info("Process definitions loaded successfully");
    }

    {% for process in processes %}
    private void loadProcessDefinition_{{ process.name }}() {
        String processName = "{{ process.name }}";

        // Check if already exists
        if (processDefinitionRepository.findByProcessName(processName).isPresent()) {
            log.info("Process definition '{}' already exists, skipping...", processName);
            return;
        }

        try {
            // Build process definition JSON
            Map<String, Object> definition = new HashMap<>();

            // States
            List<Map<String, String>> states = new ArrayList<>();
            {% for elem in process.elements %}
            {% if elem.__class__.__name__ == 'State' %}
            states.add(Map.of("name", "{{ elem.name }}", "type", "{{ elem.type if elem.type else 'ACTIVE' }}"));
            {% endif %}
            {% endfor %}
            definition.put("states", states);

            // Final states (states with no outgoing transitions)
            List<String> finalStates = new ArrayList<>();
            {% set all_from_states = [] %}
            {% for elem in process.elements %}
            {% if elem.__class__.__name__ == 'Transition' %}
            {% set _ = all_from_states.append(elem.from_state.name) %}
            {% endif %}
            {% endfor %}
            {% for elem in process.elements %}
            {% if elem.__class__.__name__ == 'State' %}
            {% if elem.name not in all_from_states %}
            finalStates.add("{{ elem.name }}");
            {% endif %}
            {% endif %}
            {% endfor %}
            definition.put("finalStates", finalStates);

            // Roles
            List<Map<String, Object>> roles = new ArrayList<>();
            {% for elem in process.elements %}
            {% if elem.__class__.__name__ == 'Role' %}
            {% set outer_index = loop.index %}
            Map<String, Object> role{{ outer_index }} = new HashMap<>();
            role{{ outer_index }}.put("name", "{{ elem.name }}");
            {% if elem.supervised_roles %}
            List<String> supervisedRoles{{ outer_index }} = new ArrayList<>();
            {% for supervised in elem.supervised_roles %}
            supervisedRoles{{ outer_index }}.add("{{ supervised.name }}");
            {% endfor %}
            role{{ outer_index }}.put("supervisedRoles", supervisedRoles{{ outer_index }});
            {% endif %}
            roles.add(role{{ outer_index }});
            {% endif %}
            {% endfor %}
            definition.put("roles", roles);

            // Role hierarchy (supervisor -> list of supervised roles)
            Map<String, List<String>> roleHierarchy = new HashMap<>();
            {% for elem in process.elements %}
            {% if elem.__class__.__name__ == 'Role' and elem.supervised_roles %}
            {% set outer_index = loop.index %}
            List<String> supervisedList{{ outer_index }} = new ArrayList<>();
            {% for supervised_role in elem.supervised_roles %}
            supervisedList{{ outer_index }}.add("{{ supervised_role.name }}");
            {% endfor %}
            roleHierarchy.put("{{ elem.name }}", supervisedList{{ outer_index }});
            {% endif %}
            {% endfor %}
            definition.put("roleHierarchy", roleHierarchy);

            // Transitions
            List<Map<String, Object>> transitions = new ArrayList<>();
            {% for elem in process.elements %}
            {% if elem.__class__.__name__ == 'Transition' %}
            Map<String, Object> transition{{ loop.index }} = new HashMap<>();
            transition{{ loop.index }}.put("name", "{{ elem.name }}");
            transition{{ loop.index }}.put("fromState", "{{ elem.from_state.name }}");
            transition{{ loop.index }}.put("toState", "{{ elem.to_state.name }}");
            {% if elem.role %}
            transition{{ loop.index }}.put("role", "{{ elem.role.name }}");
            {% endif %}
            {% if elem.auto %}
            transition{{ loop.index }}.put("auto", true);
            {% endif %}
            transitions.add(transition{{ loop.index }});
            {% endif %}
            {% endfor %}
            definition.put("transitions", transitions);

            // Steps (tasks)
            List<Map<String, Object>> steps = new ArrayList<>();
            {% set step_counter = namespace(value=0) %}
            {% for elem in process.elements %}
            {% if elem.__class__.__name__ == 'Step' %}
            {% set step_counter.value = step_counter.value + 1 %}
            Map<String, Object> step{{ step_counter.value }} = new HashMap<>();
            step{{ step_counter.value }}.put("name", "{{ elem.name }}");
            {% if elem.role %}
            step{{ step_counter.value }}.put("role", "{{ elem.role.name }}");
            {% endif %}
            {% if elem.entities %}
            List<String> entities{{ step_counter.value }} = new ArrayList<>();
            {% for entity in elem.entities %}
            entities{{ step_counter.value }}.add("{{ entity.name }}");
            {% endfor %}
            step{{ step_counter.value }}.put("entities", entities{{ step_counter.value }});
            {% endif %}
            {% if elem.operation %}
            step{{ step_counter.value }}.put("operation", "{{ elem.operation }}");
            {% endif %}
            steps.add(step{{ step_counter.value }});
            {% endif %}
            {% endfor %}
            definition.put("steps", steps);

            // Convert to JSON
            String definitionJson = objectMapper.writeValueAsString(definition);

            // Find initial state (first state or START state)
            {% set initial_state_found = namespace(value=false, name='START') %}
            {% for elem in process.elements %}
            {% if elem.__class__.__name__ == 'State' and not initial_state_found.value %}
            {% set initial_state_found.value = true %}
            {% set initial_state_found.name = elem.name %}
            {% endif %}
            {% endfor %}
            String initialState = "{{ initial_state_found.name }}";

            // Create and save process definition
            ProcessDefinition processDefinition = ProcessDefinition.builder()
                    .processName(processName)
                    .version("1.0")
                    .description("{{ process.name }} process definition")
                    .definitionJson(definitionJson)
                    .initialState(initialState)
                    .createdAt(LocalDateTime.now())
                    .build();

            processDefinitionRepository.save(processDefinition);
            log.info("Loaded process definition: {}", processName);

        } catch (Exception e) {
            log.error("Failed to load process definition: {}", processName, e);
        }
    }
    {% endfor %}
}
